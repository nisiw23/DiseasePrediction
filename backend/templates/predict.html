{% extends "layout.html" %}

{% block content %}
<form action="/proxy/5000/predict/submit" method="post">
    <label for="disease_id">Select Disease:</label>
    <select id="disease-select" name="disease_id" required>
        <option value="">-- Choose --</option>
        {% for disease in diseases %}
            <option value="{{ disease.id }}">{{ disease.name }}</option>
        {% endfor %}
    </select>

    <!-- Input Description Box -->
    <div id="description-box" style="margin-top: 20px;"></div>

    <!-- Dynamically populated input fields -->
    <div id="form-inputs" style="margin-top: 20px;"></div>

    <button type="submit" id="submit-button" style="display: none; margin-top: 20px;">View Results</button>
</form>

<script>
document.getElementById("disease-select").addEventListener("change", async function () {
    const diseaseId = this.value;
    const formInputsContainer = document.getElementById("form-inputs");
    const descriptionBox = document.getElementById("description-box");
    const submitButton = document.getElementById("submit-button");

    formInputsContainer.innerHTML = "";
    descriptionBox.innerHTML = "";
    submitButton.style.display = "none";

    if (!diseaseId) return;

    try {
        const descRes = await fetch(`${window.location.origin}/proxy/5000/diseases/${diseaseId}/input_description`);
        const descData = await descRes.json();

        if (descData.error) {
            console.error("Failed to load description:", descData.error);
            return;
        }

        // Display description box visually
        if (descData.rows) {
            const box = document.createElement("div");
            box.style.border = "2px solid #3c8dbc";
            box.style.backgroundColor = "#eaf4fc";
            box.style.padding = "15px";
            box.style.marginBottom = "20px";
            box.style.borderRadius = "8px";

            descData.rows.forEach(row => {
                const [key, value] = row;
                const line = document.createElement("div");
                line.innerHTML = `<strong>${key}</strong> - ${value}`;
                line.style.marginBottom = "8px";
                box.appendChild(line);
            });

            descriptionBox.appendChild(box);

            // Generate input fields based on the keys
            descData.rows.forEach(([key]) => {
                const wrapper = document.createElement("div");
                wrapper.style.marginBottom = "15px";

                const label = document.createElement("label");
                label.textContent = key + ":";
                label.setAttribute("for", key);
                label.style.display = "block";
                label.style.marginBottom = "5px";

                const input = document.createElement("input");
                input.type = "text";
                input.name = key;
                input.required = true;
                input.style.width = "100%";
                input.style.padding = "8px";
                input.style.boxSizing = "border-box";

                wrapper.appendChild(label);
                wrapper.appendChild(input);
                formInputsContainer.appendChild(wrapper);
            });

            submitButton.style.display = "block";
        }

    } catch (err) {
        console.error("Failed to fetch input description:", err);
    }
});
</script>

{% endblock %}
